<h1>タイムライン</h1>

<p>
  <%# ログインしている場合にのみ「新規投稿」ボタンを表示 %>
  <% if user_signed_in? %>
    <%= link_to "新しい投稿を作成する", new_post_path %>
  <% end %>
</p>

<hr>

<%# --- キャラクター応援エリア --- %>
<% if @character.present? %>
  <div style="background-color: #f0f8ff; border: 1px solid #add8e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
    <h4><%= @character.name %>からの応援メッセージ</h4>
    
    <%# app/assets/images/ に画像があれば表示されます %>
    <%= image_tag @character.image_url, alt: @character.name, width: 100 %>
    
    <p style="font-size: 1.2em; font-weight: bold;"><%= @character.cheer_message %></p>
  </div>
<% end %>
<%# --- ここまで --- %>


<%# --- 投稿一覧エリア --- %>
<% if @posts.any? %>
  <% @posts.each do |post| %>
    <div class="post" style="margin-bottom: 20px;">
      
      <%# 投稿者情報 %>
      <p>
        <strong><%= post.user.name %></strong>
        <span style="color: #888; font-size: 0.9em;">
          <%= time_ago_in_words(post.created_at) %>前
        </span>
      </p>

      <%# 投稿内容 %>
      <p>
        <%= simple_format(post.content) %>
      </p>

      <%# --- いいね機能エリア（Turbo Frameで囲む）--- %>
      <%= turbo_frame_tag "like_buttons_for_post_#{post.id}" do %>
        <div class="like-buttons" style="margin-top: 10px;">
          <span>いいね: <%= post.likes.count %></span>

          <% if user_signed_in? %>
            <% if current_user.liked?(post) %>
              <%# いいね済みの場合 → いいね解除ボタン %>
              <% like = current_user.likes.find_by(post_id: post.id) %>
              <%= link_to 'いいね解除', post_like_path(post, like), data: { turbo_method: :delete } %>
            <% else %>
              <%# まだいいねしていない場合 → いいねボタン %>
              <%= link_to 'いいね！', post_likes_path(post), data: { turbo_method: :post } %>
            <% end %>
          <% end %>
        </div>
      <% end %>
      <%# --- ここまでがいいね機能エリア --- %>

      <%# 投稿アクションボタン %>
      <div class="post-actions" style="margin-top: 10px;">
        <% if post.user == current_user %>
          <%= link_to '編集', edit_post_path(post) %>
          <%= link_to '削除', post_path(post), data: { turbo_method: :delete, turbo_confirm: '本当に削除しますか？' } %>
        <% end %>
      </div>

    </div>
    <hr>
  <% end %>
<% else %>
  <p>まだ投稿がありません。最初の投稿をしてみましょう！</p>
<% end %>